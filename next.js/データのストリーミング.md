#RSC
# ストリーミングとは

サーバーでレンダリングしたUIを、準備ができた部分から順次ブラウザに送信する機能。これにより、ユーザーはページのすべてのコンテンツが読み込まれるのを待つことなく、表示された部分から操作、閲覧を行うことができる。

![[Pasted image 20250930105339.png]]
# ストリーミングのメリット

* **体感速度の向上**: ページの初期表示をすぐに送信できるため、ユーザーにページの読み込みを速く感じさせることができる。
- **TTFB（Time to First Byte）の短縮**: サーバーが最初のHTMLを送信するまでの時間が短縮され、ページの表示パフォーマンスを向上させることができる。
- **効率的なデータ取得**: ページ全体で最も時間のかかるデータ取得処理が、他の部分のレンダリングをブロックすることがなくなる。

# Server Component でのストリーミング

ServerComponentでストリーミングを行う場合は、データを取得するコンポーネントを親コンポーネント上で`Suspense`でラップする必要がある。

```tsx
// page.tsx
import { Suspense } from "react";
import TodoList from "./todoList";

export default function Page() {
	return (
		<div>
			<h1>Todo</h1>
			{/* データの取得が完了するまでLoading...を表示 */}
			<Suspense fallback={<div>Loading...</div>}>
				<TodoList />
			</Suspense>
		</div>
	)
}
```

```tsx
// todoList.tsx
import { getTodos } from "./utils";

// Todoリストを取得・表示するコンポーネント
export default async function TodoList() {
	const todos = await getTodos();

	return (
		<div>
			{todos.map((todo, index) => (
				<div key={index}>{todo}</div>
			))}
		</div>
	)
}
```

# Client Component でのストリーミング

Client Component上では直接データを取得することができないため、[`use()`](https://ja.react.dev/reference/react/use)を使用する必要がある。(`useEffect()`を使用してブラウザ側でデータを取得することもできるが、専用のAPIを構築する必要がありあまり推奨されない)

手順としては、
1. 親コンポーネント (ServerComponent) で、データを取得するPromiseを定義する。
2. ストリーミングを行うコンポーネント (Client Component) に、1.で定義したPromiseをPropsとして渡し、コンポーネントを`Suspense`でラップする。
3. ストリーミングを行うコンポーネント内で`use()`を使用し、Promiseから値を取り出す。

```tsx
// page.tsx
import { Suspense } from "react";
import TodoList from "./todoList";
import { getTodos } from "./utils";

export default function Page() {
	const todosPromise = getTodos();

	return (
		<div>
			<h1>Todo</h1>
			{/* データの取得が完了するまでLoading...を表示 */}
			<Suspense fallback={<div>Loading...</div>}>
				<TodoList todosPromise={todosPromise}/>
			</Suspense>
		</div>
	)
}
```

```tsx
// todoList.tsx
'use client';

import { use } from 'react';

type TodoListProps = {
	todosPromise: Promise<string[]>;
}

// 検索結果に合わせてTodoリストを表示するコンポーネント
export default function TodoList({ todosPromise }: TodoListProps) {
	const todos = use(todosPromise);
	const [filterValue, setFilterValue] = useState('');

	return (
		<div>
			{todos
				.filter(todo => todo.includes(filterValue))
				.map((todo, index) => (
					<div key={index}>{todo}</div>
				))
			}
		</div>
	)
}
```